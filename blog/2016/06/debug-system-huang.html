<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Windbg,内核调试," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="使用Vmware搭建双机调试环境这里不再赘述，Google一下，有非常的多的教程。同时设置好Symbol Path。
调试详解加载nt模块的符号表这里的nt模块，并不是ntdll.dll，而是window的真实的内核模块。根据操作系统的不同，它可能是ntkrnlpa.exe,ntoskrnl.exe,ntkrnlmp.exe,ntkrpamp.exe。为了能够调试代码，我们必须要先加载这个模块的符">
<meta property="og:type" content="article">
<meta property="og:title" content="记录一次系统卡死的调试">
<meta property="og:url" content="http://www.xn--vz0au16b.com/blog/2016/06/debug-system-huang.html">
<meta property="og:site_name" content="Sven's Home">
<meta property="og:description" content="使用Vmware搭建双机调试环境这里不再赘述，Google一下，有非常的多的教程。同时设置好Symbol Path。
调试详解加载nt模块的符号表这里的nt模块，并不是ntdll.dll，而是window的真实的内核模块。根据操作系统的不同，它可能是ntkrnlpa.exe,ntoskrnl.exe,ntkrnlmp.exe,ntkrpamp.exe。为了能够调试代码，我们必须要先加载这个模块的符">
<meta property="og:updated_time" content="2016-06-05T11:23:36.909Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="记录一次系统卡死的调试">
<meta name="twitter:description" content="使用Vmware搭建双机调试环境这里不再赘述，Google一下，有非常的多的教程。同时设置好Symbol Path。
调试详解加载nt模块的符号表这里的nt模块，并不是ntdll.dll，而是window的真实的内核模块。根据操作系统的不同，它可能是ntkrnlpa.exe,ntoskrnl.exe,ntkrnlmp.exe,ntkrpamp.exe。为了能够调试代码，我们必须要先加载这个模块的符">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6292198150924928000,
      author: '管理员'
    }
  };
</script>

  <title> 记录一次系统卡死的调试 | Sven's Home </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Sven's Home</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                记录一次系统卡死的调试
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-06-05T18:32:28+08:00" content="2016-06-05">
              2016-06-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作/" itemprop="url" rel="index">
                    <span itemprop="name">工作</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/blog/2016/06/debug-system-huang.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="/blog/2016/06/debug-system-huang.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="使用Vmware搭建双机调试环境"><a href="#使用Vmware搭建双机调试环境" class="headerlink" title="使用Vmware搭建双机调试环境"></a>使用Vmware搭建双机调试环境</h2><p>这里不再赘述，Google一下，有非常的多的教程。同时设置好Symbol Path。</p>
<h2 id="调试详解"><a href="#调试详解" class="headerlink" title="调试详解"></a>调试详解</h2><h3 id="加载nt模块的符号表"><a href="#加载nt模块的符号表" class="headerlink" title="加载nt模块的符号表"></a>加载nt模块的符号表</h3><p>这里的nt模块，并不是ntdll.dll，而是window的真实的内核模块。根据操作系统的不同，它可能是ntkrnlpa.exe,ntoskrnl.exe,ntkrnlmp.exe,ntkrpamp.exe。为了能够调试代码，我们必须要先加载这个模块的符号表。<br>命令行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; .reload /<span class="keyword">if</span> nt</span><br><span class="line">kd&gt; g</span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">*******************************************************************************</span><br><span class="line">*                                                                             *</span><br><span class="line">*   You are seeing this message because you pressed either                    *</span><br><span class="line">*       CTRL+C (<span class="keyword">if</span> you run kd.exe) or,                                        *</span><br><span class="line">*       CTRL+BREAK (<span class="keyword">if</span> you run W<span class="keyword">in</span>DBG),                                       *</span><br><span class="line">*   on your debugger machine<span class="string">'s keyboard.                                      *</span><br><span class="line">*                                                                             *</span><br><span class="line">*                   THIS IS NOT A BUG OR A SYSTEM CRASH                       *</span><br><span class="line">*                                                                             *</span><br><span class="line">* If you did not intend to break into the debugger, press the "g" key, then   *</span><br><span class="line">* press the "Enter" key now.  This message might immediately reappear.  If it *</span><br><span class="line">* does, press "g" and "Enter" again.                                          *</span><br><span class="line">*                                                                             *</span><br><span class="line">*******************************************************************************</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">83eb2110 cc              int     3</span></span><br></pre></td></tr></table></figure></p>
<h3 id="显示正在运行的进程"><a href="#显示正在运行的进程" class="headerlink" title="显示正在运行的进程"></a>显示正在运行的进程</h3><p>可以看到，当前运行了很多个LoaderLockExe.exe，这个是我们的测试程序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process 0 0</span><br><span class="line">**** NT ACTIVE PROCESS DUMP ****</span><br><span class="line">PROCESS 8634b820  SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000</span><br><span class="line">    DirBase: 00185000  ObjectTable: 89e01b28  HandleCount: 551.</span><br><span class="line">    Image: System</span><br><span class="line"></span><br><span class="line">PROCESS 86f0c1e0  SessionId: none  Cid: 00<span class="built_in">fc</span>    Peb: 7ffdf000  ParentCid: 0004</span><br><span class="line">    DirBase: 3f33b020  ObjectTable: 8c4cac68  HandleCount:  29.</span><br><span class="line">    Image: smss.exe</span><br><span class="line"></span><br><span class="line">PROCESS 8769a718  SessionId: 0  Cid: 0150    Peb: 7ffd5000  ParentCid: 013c</span><br><span class="line">    DirBase: 3f33b060  ObjectTable: 99606e40  HandleCount: 582.</span><br><span class="line">    Image: csrss.exe</span><br><span class="line"></span><br><span class="line">PROCESS 876f9530  SessionId: 1  Cid: 0184    Peb: 7ffdf000  ParentCid: 017c</span><br><span class="line">    DirBase: 3f33b0a0  ObjectTable: 8a01f9c0  HandleCount: 473.</span><br><span class="line">    Image: csrss.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87703530  SessionId: 0  Cid: 018c    Peb: 7ffdd000  ParentCid: 013c</span><br><span class="line">    DirBase: 3f33b0c0  ObjectTable: 8a034638  HandleCount:  79.</span><br><span class="line">    Image: wininit.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87718530  SessionId: 1  Cid: 01b0    Peb: 7ffd9000  ParentCid: 017c</span><br><span class="line">    DirBase: 3f33b040  ObjectTable: 8a045e30  HandleCount: 110.</span><br><span class="line">    Image: winlogon.exe</span><br><span class="line"></span><br><span class="line">PROCESS 8807f518  SessionId: 0  Cid: 01<span class="built_in">fc</span>    Peb: 7ffdb000  ParentCid: 018c</span><br><span class="line">    DirBase: 3f33b080  ObjectTable: 8a127008  HandleCount: 259.</span><br><span class="line">    Image: services.exe</span><br><span class="line"></span><br><span class="line">PROCESS 880808d0  SessionId: 0  Cid: 0204    Peb: 7ffdf000  ParentCid: 018c</span><br><span class="line">    DirBase: 3f33b0e0  ObjectTable: 8a127150  HandleCount:  41.</span><br><span class="line">    Image: HutiehuaApp.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88087428  SessionId: 0  Cid: 0210    Peb: 7ffdf000  ParentCid: 018c</span><br><span class="line">    DirBase: 3f33b100  ObjectTable: 8a139bb8  HandleCount: 564.</span><br><span class="line">    Image: lsass.exe</span><br><span class="line"></span><br><span class="line">PROCESS 8808ad40  SessionId: 0  Cid: 0218    Peb: 7ffd3000  ParentCid: 0150</span><br><span class="line">    DirBase: 3f33b120  ObjectTable: 8a126de0  HandleCount:  58.</span><br><span class="line">    Image: conhost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 8808b218  SessionId: 0  Cid: 0220    Peb: 7ffdc000  ParentCid: 018c</span><br><span class="line">    DirBase: 3f33b140  ObjectTable: 8a146060  HandleCount: 151.</span><br><span class="line">    Image: lsm.exe</span><br><span class="line"></span><br><span class="line">PROCESS 880c2638  SessionId: 0  Cid: 0280    Peb: 7ffd9000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b160  ObjectTable: 8a1e6008  HandleCount: 359.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 880e2d40  SessionId: 0  Cid: 02d4    Peb: 7ffd7000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b180  ObjectTable: 8a1cf7f0  HandleCount: 282.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 869f1030  SessionId: 0  Cid: 0350    Peb: 7ffd8000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b1c0  ObjectTable: 8aeeaa18  HandleCount: 479.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 86d52420  SessionId: 0  Cid: 0374    Peb: 7ffdc000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b1e0  ObjectTable: 8aee1e70  HandleCount: 431.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 8813d030  SessionId: 0  Cid: 038c    Peb: 7ffda000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b200  ObjectTable: 8a1a49c8  HandleCount: 1069.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 8816c570  SessionId: 0  Cid: 03e4    Peb: 7ffda000  ParentCid: 0350</span><br><span class="line">    DirBase: 3f33b220  ObjectTable: 8af89188  HandleCount: 111.</span><br><span class="line">    Image: audiodg.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88188030  SessionId: 0  Cid: 0430    Peb: 7ffd5000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b240  ObjectTable: 8a189e20  HandleCount: 527.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 881a7030  SessionId: 0  Cid: 04a4    Peb: 7ffde000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b260  ObjectTable: 8be264d0  HandleCount: 355.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87751030  SessionId: 0  Cid: 0554    Peb: 7ffd3000  ParentCid: 04e8</span><br><span class="line">    DirBase: 3f33b2c0  ObjectTable: 8be16b48  HandleCount:  96.</span><br><span class="line">    Image: LvaNac.exe</span><br><span class="line"></span><br><span class="line">PROCESS 876c1030  SessionId: 0  Cid: 055c    Peb: 7ffdf000  ParentCid: 0150</span><br><span class="line">    DirBase: 3f33b2e0  ObjectTable: 8be33ab8  HandleCount:  58.</span><br><span class="line">    Image: conhost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 876e2d40  SessionId: 1  Cid: 05cc    Peb: 7ffdf000  ParentCid: 0374</span><br><span class="line">    DirBase: 3f33b380  ObjectTable: 8de3ffc0  HandleCount: 157.</span><br><span class="line">    Image: dwm.exe</span><br><span class="line"></span><br><span class="line">PROCESS 876e49b8  SessionId: 1  Cid: 05e4    Peb: 7ffdc000  ParentCid: 05bc</span><br><span class="line">    DirBase: 3f33b3a0  ObjectTable: 8be11398  HandleCount: 877.</span><br><span class="line">    Image: explorer.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87722d40  SessionId: 0  Cid: 0600    Peb: 7ffdf000  ParentCid: 038c</span><br><span class="line">    DirBase: 3f33b3c0  ObjectTable: 8dec8c30  HandleCount:  86.</span><br><span class="line">    Image: taskeng.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87723a90  SessionId: 0  Cid: 0608    Peb: 7ffd9000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b3e0  ObjectTable: 8de6ffc0  HandleCount: 341.</span><br><span class="line">    Image: spoolsv.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87756a58  SessionId: 0  Cid: 0674    Peb: 7ffd5000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b420  ObjectTable: 8dee7870  HandleCount: 193.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87763a58  SessionId: 0  Cid: 0698    Peb: 7ffda000  ParentCid: 0600</span><br><span class="line">    DirBase: 3f33b440  ObjectTable: 8deec810  HandleCount: 8297.</span><br><span class="line">    Image: OEM8.exe</span><br><span class="line"></span><br><span class="line">PROCESS 8775<span class="built_in">cd</span>40  SessionId: 0  Cid: 06c4    Peb: 7ffda000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b400  ObjectTable: 8df00b78  HandleCount: 313.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88166958  SessionId: 1  Cid: 06dc    Peb: 7ffdb000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b460  ObjectTable: 8de403b0  HandleCount: 212.</span><br><span class="line">    Image: taskhost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 882795e8  SessionId: 0  Cid: 0774    Peb: 7ffd7000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b4a0  ObjectTable: 8dfc2b48  HandleCount:  64.</span><br><span class="line">    Image: srvany.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88277790  SessionId: 1  Cid: 077c    Peb: 7ffd6000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b480  ObjectTable: 8dfbb048  HandleCount: 116.</span><br><span class="line">    Image: GetCorbicula.exe</span><br><span class="line"></span><br><span class="line">PROCESS 8828<span class="built_in">cd</span>40  SessionId: 1  Cid: 0790    Peb: 7ffdb000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b4c0  ObjectTable: 8dfc5968  HandleCount:  65.</span><br><span class="line">    Image: Tinaiat.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88291030  SessionId: 0  Cid: 07a4    Peb: 7ffd9000  ParentCid: 0774</span><br><span class="line">    DirBase: 3f33b4e0  ObjectTable: 00000000  HandleCount:   0.</span><br><span class="line">    Image: HEU_KMS_Renewal.exe</span><br><span class="line"></span><br><span class="line">PROCESS 8829f030  SessionId: 1  Cid: 07b0    Peb: 7ffd6000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b500  ObjectTable: 8dfe4618  HandleCount: 113.</span><br><span class="line">    Image: UaaClient.exe</span><br><span class="line"></span><br><span class="line">PROCESS 8828b310  SessionId: 0  Cid: 07e8    Peb: 7ffd4000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b2a0  ObjectTable: 8dfbc610  HandleCount: 293.</span><br><span class="line">    Image: vmtoolsd.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88308c30  SessionId: 1  Cid: 0214    Peb: 7ffd4000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b520  ObjectTable: 95ea7e80  HandleCount: 196.</span><br><span class="line">    Image: vmtoolsd.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87758030  SessionId: 1  Cid: 06d8    Peb: 7ffd8000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b300  ObjectTable: 95ed4140  HandleCount: 155.</span><br><span class="line">    Image: GEUU20203.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87d553c0  SessionId: 0  Cid: 0834    Peb: 7ffdf000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b280  ObjectTable: 96c52cb8  HandleCount: 149.</span><br><span class="line">    Image: TPAutoConnSvc.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87e2ad40  SessionId: 0  Cid: 09a0    Peb: 7ffda000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b680  ObjectTable: 96c03448  HandleCount: 101.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88098030  SessionId: 1  Cid: 09c4    Peb: 7ffdd000  ParentCid: 094c</span><br><span class="line">    DirBase: 3f33b6c0  ObjectTable: 8be64c88  HandleCount: 639.</span><br><span class="line">    Image: UniAccessAgent.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87e1ab88  SessionId: 0  Cid: 09ec    Peb: 7ffd6000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b6e0  ObjectTable: 96c8a0a0  HandleCount: 596.</span><br><span class="line">    Image: SearchIndexer.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87e63470  SessionId: 1  Cid: 0a74    Peb: 7ffd4000  ParentCid: 0834</span><br><span class="line">    DirBase: 3f33b320  ObjectTable: 967b57b8  HandleCount: 126.</span><br><span class="line">    Image: TPAutoConnect.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87e75110  SessionId: 1  Cid: 0aa4    Peb: 7ffd4000  ParentCid: 0184</span><br><span class="line">    DirBase: 3f33b600  ObjectTable: 96c03ef0  HandleCount:  59.</span><br><span class="line">    Image: conhost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87e078b8  SessionId: 0  Cid: 0b40    Peb: 7ffdf000  ParentCid: 0280</span><br><span class="line">    DirBase: 3f33b6a0  ObjectTable: 927728b0  HandleCount: 206.</span><br><span class="line">    Image: WmiPrvSE.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87df54e0  SessionId: 0  Cid: 0b90    Peb: 7ffdc000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b5e0  ObjectTable: 9666e740  HandleCount: 202.</span><br><span class="line">    Image: dllhost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 869a4d40  SessionId: 0  Cid: 0c10    Peb: 7ffde000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b660  ObjectTable: 963f2508  HandleCount: 229.</span><br><span class="line">    Image: dllhost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87eeed40  SessionId: 1  Cid: 0c84    Peb: 7ffdf000  ParentCid: 09c4</span><br><span class="line">    DirBase: 3f33b580  ObjectTable: 8be08cb8  HandleCount:  83.</span><br><span class="line">    Image: AntiMHT.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87ef5d40  SessionId: 0  Cid: 0ca4    Peb: 7ffdd000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b700  ObjectTable: 963d85b0  HandleCount: 201.</span><br><span class="line">    Image: wmpnetwk.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87edcd40  SessionId: 1  Cid: 0cf0    Peb: 7ffde000  ParentCid: 0184</span><br><span class="line">    DirBase: 3f33b340  ObjectTable: 96ca7d40  HandleCount:  69.</span><br><span class="line">    Image: conhost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 869eb460  SessionId: 0  Cid: 0db0    Peb: 7ffd8000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b1a0  ObjectTable: 963e8988  HandleCount: 177.</span><br><span class="line">    Image: msdtc.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87f70d40  SessionId: 1  Cid: 0de8    Peb: 7ffd6000  ParentCid: 09ec</span><br><span class="line">    DirBase: 3f33b720  ObjectTable: 96396880  HandleCount: 272.</span><br><span class="line">    Image: SearchProtocolHost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87f715e8  SessionId: 0  Cid: 0e68    Peb: 7ffde000  ParentCid: 09ec</span><br><span class="line">    DirBase: 3f33b5c0  ObjectTable: 96d187c8  HandleCount:  78.</span><br><span class="line">    Image: SearchFilterHost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 880265b0  SessionId: 0  Cid: 0aec    Peb: 7ffdd000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b5a0  ObjectTable: 99281a80  HandleCount: 114.</span><br><span class="line">    Image: VSSVC.exe</span><br><span class="line"></span><br><span class="line">PROCESS 86fed030  SessionId: 0  Cid: 0f50    Peb: 7ffd3000  ParentCid: 0280</span><br><span class="line">    DirBase: 3f33b740  ObjectTable: 00000000  HandleCount:   0.</span><br><span class="line">    Image: WmiPrvSE.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88196a20  SessionId: 0  Cid: 08f4    Peb: 7ffd7000  ParentCid: 0280</span><br><span class="line">    DirBase: 3f33b860  ObjectTable: 992655e8  HandleCount: 117.</span><br><span class="line">    Image: WmiPrvSE.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87ddb060  SessionId: 1  Cid: 0104    Peb: 7ffdf000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b760  ObjectTable: 95ed5e78  HandleCount:  65.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87d6c030  SessionId: 1  Cid: 0784    Peb: 7ffd5000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b780  ObjectTable: 8dff00d8  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 869d1d40  SessionId: 1  Cid: 0584    Peb: 7ffd5000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b620  ObjectTable: 8c5c0c40  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87e0e6d0  SessionId: 1  Cid: 0920    Peb: 7ffd6000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b820  ObjectTable: 8c5b7620  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87dce440  SessionId: 1  Cid: 0d04    Peb: 7ffde000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b7a0  ObjectTable: 9de4f1f8  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87e65030  SessionId: 1  Cid: 0a10    Peb: 7ffdf000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b640  ObjectTable: 96d37<span class="built_in">fc</span>0  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87712030  SessionId: 1  Cid: 09d4    Peb: 7ffd9000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b560  ObjectTable: 8be34630  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87e12938  SessionId: 1  Cid: 054c    Peb: 7ffdf000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b360  ObjectTable: 9ded1a60  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87d7e548  SessionId: 1  Cid: 0e74    Peb: 7ffdd000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b840  ObjectTable: 99282b18  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87d86030  SessionId: 0  Cid: 04d4    Peb: 7ffd4000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b800  ObjectTable: 9deba608  HandleCount: 166.</span><br><span class="line">    Image: sppsvc.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87d8d030  SessionId: 1  Cid: 0c5c    Peb: 7ffdb000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b880  ObjectTable: 9de92190  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87cda9d0  SessionId: 1  Cid: 09dc    Peb: 7ffd8000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b540  ObjectTable: 8c5cb560  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87e0e9d8  SessionId: 1  Cid: 0694    Peb: 7ffd3000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b7c0  ObjectTable: 9de840a0  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87e7b1f8  SessionId: 1  Cid: 05c0    Peb: 7ffdc000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b7e0  ObjectTable: 8c5afd08  HandleCount:  64.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 86ff74f8  SessionId: 1  Cid: 09a8    Peb: 7ffd9000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b8e0  ObjectTable: 9df1b430  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87ebe030  SessionId: 1  Cid: 07d0    Peb: 7ffd4000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b8a0  ObjectTable: 9df67540  HandleCount:  64.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87f57930  SessionId: 1  Cid: 0ce4    Peb: 7ffdd000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b8c0  ObjectTable: 8c5c2590  HandleCount:  63.</span><br><span class="line">    Image: LoaderLockExe.exe</span><br><span class="line"></span><br><span class="line">PROCESS 868894a8  SessionId: 0  Cid: 04f4    Peb: 7ffdf000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b900  ObjectTable: 9de25bb8  HandleCount: 447.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88400030  SessionId: 1  Cid: 0e24    Peb: 7ffd7000  ParentCid: 05e4</span><br><span class="line">    DirBase: 3f33b960  ObjectTable: 96615ec0  HandleCount: 113.</span><br><span class="line">    Image: Poria.exe</span><br><span class="line"></span><br><span class="line">PROCESS 881e2850  SessionId: 1  Cid: 05c4    Peb: 7ffdf000  ParentCid: 09c4</span><br><span class="line">    DirBase: 3f33b940  ObjectTable: a4732<span class="built_in">cd</span>0  HandleCount:   3.</span><br><span class="line">    Image: UAAExt.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88447030  SessionId: 0  Cid: 0650    Peb: 7ffd9000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b980  ObjectTable: 927ee520  HandleCount:  41.</span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87df18d8  SessionId: 0  Cid: 07d4    Peb: 7ffdd000  ParentCid: 01<span class="built_in">fc</span></span><br><span class="line">    DirBase: 3f33b920  ObjectTable: 9df21428  HandleCount:   0.</span><br><span class="line">    Image: taskhost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 87f085c8  SessionId: 1  Cid: 04f0    Peb: 7ffdd000  ParentCid: 0e24</span><br><span class="line">    DirBase: 3f33b9a0  ObjectTable: 8c5b5b20  HandleCount:   0.</span><br><span class="line">    Image: SetGlobalVar.exe</span><br><span class="line"></span><br><span class="line">PROCESS 868f4740  SessionId: 1  Cid: 0fb8    Peb: 7ffd3000  ParentCid: 0184</span><br><span class="line">    DirBase: 3f33b9c0  ObjectTable: aaf43118  HandleCount:   0.</span><br><span class="line">    Image: conhost.exe</span><br><span class="line"></span><br><span class="line">PROCESS 88415030  SessionId: 1  Cid: 0868    Peb: 7ffdd000  ParentCid: 09c4</span><br><span class="line">    DirBase: 3f33b9e0  ObjectTable: 963d5e38  HandleCount:   0.</span><br><span class="line">    Image: UAAExt.exe</span><br></pre></td></tr></table></figure>
<h3 id="附加到任意一个异常进程"><a href="#附加到任意一个异常进程" class="headerlink" title="附加到任意一个异常进程"></a>附加到任意一个异常进程</h3><p>可以看到，我们的进程在等待Mutant对象，当前这个对象正在被线程87d42030占有。</p>
<pre><code class="bash">kd&gt; !process 86ff74f8 2
PROCESS 86ff74f8  SessionId: 1  Cid: 09a8    Peb: 7ffd9000  ParentCid: 05e4
    DirBase: 3f33b8e0  ObjectTable: 9df1b430  HandleCount:  63.
    Image: LoaderLockExe.exe

        THREAD 87d73550  Cid 09a8.0a30  Teb: 7ffdf000 W<span class="keyword">in</span>32Thread: fe053568 WAIT: (UserRequest) UserMode Non-Alertable
            880ee7d8  Mutant - owning thread 87d42030

        THREAD 880c4180  Cid 09a8.0a88  Teb: 7ffde000 W<span class="keyword">in</span>32Thread: 00000000 WAIT: (Executive) UserMode Non-Alertable
            87f212f4  Semaphore Limit 0x7fffffff

        THREAD 88418ac0  Cid 09a8.0c2c  Teb: 7ffdd000 W<span class="keyword">in</span>32Thread: 00000000 WAIT: (UserRequest) UserMode Non-Alertable
            880ee7d8  Mutant - owning thread 87d42030
</code></pre>
<h3 id="查看异常的线程信息"><a href="#查看异常的线程信息" class="headerlink" title="查看异常的线程信息"></a>查看异常的线程信息</h3><p>可以看到，这个线程属于87ddb060这个进程。</p>
<pre><code class="bash">kd&gt; !thread 87d42030
THREAD 87d42030  Cid 0104.0ffc  Teb: 7ffde000 W<span class="keyword">in</span>32Thread: fe8e6b50 WAIT: (UserRequest) UserMode Non-Alertable
    87<span class="built_in">fc</span>7e58  SynchronizationEvent
Not impersonating
DeviceMap                 8a1fa350
Owning Process            87ddb060       Image:         LoaderLockExe.exe
Attached Process          N/A            Image:         N/A
Wait Start TickCount      11770          Ticks: 2920 (0:00:00:45.552)
Context Switch Count      3144             
UserTime                  00:00:00.124
KernelTime                00:00:00.031
W<span class="keyword">in</span>32 Start Address 0x00dddc98
Stack Init 8c666ed0 Current 8c666ac8 Base 8c667000 Limit 8c664000 Call 0
Priority 8 BasePriority 8 UnusualBoost 0 ForegroundBoost 0 IoPriority 2 PagePriority 5
ChildEBP RetAddr  Args to Child              
8c666ae0 83eb569d 87d42030 83f65f08 83f62d20 nt!KiSwapContext+0x26 (FPO: [Uses EBP] [0,0,4])
8c666b18 83eb44f7 87d420f0 87d42030 87<span class="built_in">fc</span>7e58 nt!KiSwapThread+0x266
8c666b40 83eae0cf 87d42030 87d420f0 00000000 nt!KiCommitThreadWait+0x1df
8c666bb8 84060bad 87<span class="built_in">fc</span>7e58 00000006 8c666b01 nt!KeWaitForSingleObject+0x393
8c666c20 83e751ea 00000104 00000000 00000000 nt!NtWaitForSingleObject+0xc6
8c666c20 77a470b4 00000104 00000000 00000000 nt!KiFastCallEntry+0x12a (FPO: [0,3] TrapFrame @ 8c666c34)
WARNING: Frame IP not <span class="keyword">in</span> any known module. Following frames may be wrong.
0031ed8c 00000000 00000000 00000000 00000000 0x77a470b4
</code></pre>
<h3 id="切换调试上下文件到异常进程"><a href="#切换调试上下文件到异常进程" class="headerlink" title="切换调试上下文件到异常进程"></a>切换调试上下文件到异常进程</h3><p>注意需要让内核运行一下(g指令)，才能切换到上下文。这个时候我们已经可以调试87ddb060这个进程了。</p>
<pre><code class="bash">kd&gt; .process /i 87ddb060
You need to <span class="built_in">continue</span> execution (press <span class="string">'g'</span> &lt;enter&gt;) <span class="keyword">for</span> the context
to be switched. When the debugger breaks <span class="keyword">in</span> again, you will be <span class="keyword">in</span>
the new process context.
kd&gt; g
Break instruction exception - code 80000003 (first chance)
nt!RtlpBreakWithStatusInstruction:
83eb2110 cc              int     3
</code></pre>
<h3 id="加载应用层符号表，显示异常进程的信息"><a href="#加载应用层符号表，显示异常进程的信息" class="headerlink" title="加载应用层符号表，显示异常进程的信息"></a>加载应用层符号表，显示异常进程的信息</h3><pre><code class="bash">kd&gt; .reload /user
Loading User Symbols
..............................................
kd&gt; !process 87ddb060
PROCESS 87ddb060  SessionId: 1  Cid: 0104    Peb: 7ffdf000  ParentCid: 05e4
    DirBase: 3f33b760  ObjectTable: 95ed5e78  HandleCount:  65.
    Image: LoaderLockExe.exe
    VadRoot 87dc5700 Vads 92 Clone 0 Private 639. Modified 495. Locked 0.
    DeviceMap 8a1fa350
    Token                             962dc908
    ElapsedTime                       00:03:47.781
    UserTime                          00:00:00.156
    KernelTime                        00:00:00.124
    QuotaPoolUsage[PagedPool]         0
    QuotaPoolUsage[NonPagedPool]      0
    Working Set Sizes (now,min,max)  (2695, 50, 345) (10780KB, 200KB, 1380KB)
    PeakWorkingSetSize                2768
    VirtualSize                       73 Mb
    PeakVirtualSize                   73 Mb
    PageFaultCount                    23608
    MemoryPriority                    BACKGROUND
    BasePriority                      8
    CommitCharge                      736

        THREAD 87d42030  Cid 0104.0ffc  Teb: 7ffde000 W<span class="keyword">in</span>32Thread: fe8e6b50 WAIT: (UserRequest) UserMode Non-Alertable
            87<span class="built_in">fc</span>7e58  SynchronizationEvent
        Not impersonating
        DeviceMap                 8a1fa350
        Owning Process            87ddb060       Image:         LoaderLockExe.exe
        Attached Process          N/A            Image:         N/A
        Wait Start TickCount      11770          Ticks: 2979 (0:00:00:46.472)
        Context Switch Count      3144             
        UserTime                  00:00:00.124
        KernelTime                00:00:00.031
*** WARNING: Unable to verify checksum <span class="keyword">for</span> LoaderLockExe.exe
*** ERROR: Module load completed but symbols could not be loaded <span class="keyword">for</span> LoaderLockExe.exe
        W<span class="keyword">in</span>32 Start Address LoaderLockExe (0x00dddc98)
        Stack Init 8c666ed0 Current 8c666ac8 Base 8c667000 Limit 8c664000 Call 0
        Priority 8 BasePriority 8 UnusualBoost 0 ForegroundBoost 0 IoPriority 2 PagePriority 5
*** WARNING: Unable to verify checksum <span class="keyword">for</span> MozartBreathCore.dll
        ChildEBP RetAddr  
        8c666ae0 83eb569d nt!KiSwapContext+0x26 (FPO: [Uses EBP] [0,0,4])
        8c666b18 83eb44f7 nt!KiSwapThread+0x266
        8c666b40 83eae0cf nt!KiCommitThreadWait+0x1df
        8c666bb8 84060bad nt!KeWaitForSingleObject+0x393
        8c666c20 83e751ea nt!NtWaitForSingleObject+0xc6
        8c666c20 77a470b4 nt!KiFastCallEntry+0x12a (FPO: [0,3] TrapFrame @ 8c666c34)
        0031ed24 77a46a24 ntdll!KiFastSystemCallRet (FPO: [0,0,0])
        0031ed28 77a32264 ntdll!NtWaitForSingleObject+0xc (FPO: [3,0,0])
        0031ed8c 77a32148 ntdll!RtlpWaitOnCriticalSection+0x13e (FPO: [Non-Fpo])
        0031edb4 77a600e1 ntdll!RtlEnterCriticalSection+0x150 (FPO: [Non-Fpo])
        0031edec 75cc7b13 ntdll!LdrLockLoaderLock+0xe4 (FPO: [Non-Fpo])
        0031ee38 754c42f8 KERNELBASE!GetModuleFileNameW+0x75 (FPO: [Non-Fpo])
        0031f1f4 7550a5a4 MozartBreathCore!HD<span class="built_in">bg</span>View::write+0x188 (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hdbgview.cpp @ 309]
        0031f204 754dcc2b MozartBreathCore!HString::debugview+0x24 (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hstring.cpp @ 3556]
        0031f20c 754dcc0d MozartBreathCore!HFileLog::debugview+0xb (CONV: cdecl) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hfilelog.cpp @ 305]
        0031f21c 7544e72a MozartBreathCore!HFileLog::system_debug_<span class="built_in">log</span>+0x1d (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hfilelog.cpp @ 295]
        0031f3cc 75432a51 MozartBreathCore!MBCFile::action_close_file_handle+0x28a (CONV: thiscall) [e:\works\uniaccess_unimon\uniaccess3_1\模块设计与源代码\uniaccessagent\mozartbreath\mozartbreathcore\mbcfiletool.cpp @ 2917]
        0031f464 00de0392 MozartBreathCore!hook_CloseHandle+0x81 (CONV: stdcall) [e:\works\uniaccess_unimon\uniaccess3_1\模块设计与源代码\uniaccessagent\mozartbreath\mozartbreathcore\mbcfile.cpp @ 762]
WARNING: Stack unwind information not available. Following frames may be wrong.
        0031f650 75ef86ef LoaderLockExe+0x40392
        0031f67c 75ef8876 USER32!InternalCallW<span class="keyword">in</span>Proc+0x23
        0031f6f4 75ef89b5 USER32!UserCallW<span class="keyword">in</span>ProcCheckWow+0x14b (FPO: [Non-Fpo])
        0031f754 75ef8e9c USER32!DispatchMessageWorker+0x35e (FPO: [Non-Fpo])
        0031f764 00ddfe7e USER32!DispatchMessageW+0xf (FPO: [Non-Fpo])
        0031f860 00df4745 LoaderLockExe+0x3fe7e
        0031f904 00df45cf LoaderLockExe+0x54745
        0031f90c 769f3c45 LoaderLockExe+0x545cf
        0031f918 77a637f5 kernel32!BaseThreadInitThunk+0xe (FPO: [Non-Fpo])
        0031f958 77a637c8 ntdll!__RtlUserThreadStart+0x70 (FPO: [Non-Fpo])
        0031f970 00000000 ntdll!_RtlUserThreadStart+0x1b (FPO: [Non-Fpo])

        THREAD 880c7a60  Cid 0104.08a4  Teb: 7ffdd000 W<span class="keyword">in</span>32Thread: 00000000 WAIT: (Executive) UserMode Non-Alertable
            87e7a704  Semaphore Limit 0x7fffffff
        Not impersonating
        DeviceMap                 8a1fa350
        Owning Process            87ddb060       Image:         LoaderLockExe.exe
        Attached Process          N/A            Image:         N/A
        Wait Start TickCount      9334           Ticks: 5415 (0:00:01:24.474)
        Context Switch Count      2             
        UserTime                  00:00:00.000
        KernelTime                00:00:00.000
        W<span class="keyword">in</span>32 Start Address ntdll!EtwpNotificationThread (0x77a1f4c0)
        Stack Init 9d9bced0 Current 9d9bca70 Base 9d9bd000 Limit 9d9ba000 Call 0
        Priority 8 BasePriority 8 UnusualBoost 0 ForegroundBoost 0 IoPriority 2 PagePriority 5
        ChildEBP RetAddr  
        9d9bca88 83eb569d nt!KiSwapContext+0x26 (FPO: [Uses EBP] [0,0,4])
        9d9bcac0 83eb44f7 nt!KiSwapThread+0x266
        9d9bcae8 83eae0cf nt!KiCommitThreadWait+0x1df
        9d9bcb60 840204a4 nt!KeWaitForSingleObject+0x393
        9d9bcbb8 84088c3c nt!EtwpReceiveNotification+0xf4
        9d9bcc14 83e751ea nt!NtTraceControl+0x281
        9d9bcc14 77a470b4 nt!KiFastCallEntry+0x12a (FPO: [0,3] TrapFrame @ 9d9bcc34)
        01bbfef4 77a46924 ntdll!KiFastSystemCallRet (FPO: [0,0,0])
        01bbfef8 77a1f505 ntdll!NtTraceControl+0xc (FPO: [6,0,0])
        01bbff28 769f3c45 ntdll!EtwpNotificationThread+0x3d (FPO: [Non-Fpo])
        01bbff34 77a637f5 kernel32!BaseThreadInitThunk+0xe (FPO: [Non-Fpo])
        01bbff74 77a637c8 ntdll!__RtlUserThreadStart+0x70 (FPO: [Non-Fpo])
        01bbff8c 00000000 ntdll!_RtlUserThreadStart+0x1b (FPO: [Non-Fpo])

        THREAD 88178b58  Cid 0104.0ec0  Teb: 7ffdc000 W<span class="keyword">in</span>32Thread: 00000000 WAIT: (UserRequest) UserMode Non-Alertable
            880ee7d8  Mutant - owning thread 87d42030
        Not impersonating
        DeviceMap                 8a1fa350
        Owning Process            87ddb060       Image:         LoaderLockExe.exe
        Attached Process          N/A            Image:         N/A
        Wait Start TickCount      11777          Ticks: 2972 (0:00:00:46.363)
        Context Switch Count      3             
        UserTime                  00:00:00.000
        KernelTime                00:00:00.000
        W<span class="keyword">in</span>32 Start Address LoaderLockExe (0x00ddde00)
        Stack Init 9600bed0 Current 9600bac8 Base 9600c000 Limit 96009000 Call 0
        Priority 8 BasePriority 8 UnusualBoost 0 ForegroundBoost 0 IoPriority 2 PagePriority 5
        ChildEBP RetAddr  
        9600bae0 83eb569d nt!KiSwapContext+0x26 (FPO: [Uses EBP] [0,0,4])
        9600bb18 83eb44f7 nt!KiSwapThread+0x266
        9600bb40 83eae0cf nt!KiCommitThreadWait+0x1df
        9600bbb8 84060bad nt!KeWaitForSingleObject+0x393
        9600bc20 83e751ea nt!NtWaitForSingleObject+0xc6
        9600bc20 77a470b4 nt!KiFastCallEntry+0x12a (FPO: [0,3] TrapFrame @ 9600bc34)
        00d7f1d0 77a46a24 ntdll!KiFastSystemCallRet (FPO: [0,0,0])
        00d7f1d4 75cc179c ntdll!NtWaitForSingleObject+0xc (FPO: [3,0,0])
        00d7f240 769ebaf3 KERNELBASE!WaitForSingleObjectEx+0x98 (FPO: [Non-Fpo])
        00d7f258 769ebaa2 kernel32!WaitForSingleObjectExImplementation+0x75 (FPO: [Non-Fpo])
        00d7f26c 754f7223 kernel32!WaitForSingleObject+0x12 (FPO: [Non-Fpo])
        00d7f284 754c424a MozartBreathCore!HMutexEx::lock+0x33 (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\ipc_tools\hmutexex.cpp @ 259]
        00d7f634 7550a5a4 MozartBreathCore!HD<span class="built_in">bg</span>View::write+0xda (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hdbgview.cpp @ 293]
        00d7f644 754dcc2b MozartBreathCore!HString::debugview+0x24 (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hstring.cpp @ 3556]
        00d7f64c 754dcc0d MozartBreathCore!HFileLog::debugview+0xb (CONV: cdecl) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hfilelog.cpp @ 305]
        00d7f65c 75461e21 MozartBreathCore!HFileLog::system_debug_<span class="built_in">log</span>+0x1d (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hfilelog.cpp @ 295]
        00d7f6e8 754a9069 MozartBreathCore!MBCGlobal::is_loader_lock_locked+0xd1 (CONV: thiscall) [e:\works\uniaccess_unimon\uniaccess3_1\模块设计与源代码\uniaccessagent\mozartbreath\mozartbreathcore\mbcglobal.cpp @ 3389]
        00d7f6<span class="built_in">fc</span> 7544c33e MozartBreathCore!MBCReEntryMgr::is_re_entry+0x49 (CONV: thiscall) [e:\works\uniaccess_unimon\uniaccess3_1\模块设计与源代码\uniaccessagent\mozartbreath\mozartbreathcore\mbcreentrymgr.cpp @ 125]
        00d7f9b0 75431794 MozartBreathCore!MBCFile::action_create_file+0x15e (CONV: thiscall) [e:\works\uniaccess_unimon\uniaccess3_1\模块设计与源代码\uniaccessagent\mozartbreath\mozartbreathcore\mbcfiletool.cpp @ 2475]
        00d7<span class="built_in">fc</span>04 77a6058b MozartBreathCore!hook_ZwOpenFile+0xb4 (CONV: stdcall) [e:\works\uniaccess_unimon\uniaccess3_1\模块设计与源代码\uniaccessagent\mozartbreath\mozartbreathcore\mbcfile.cpp @ 491]
        00d7<span class="built_in">fc</span>9c 77a5fbc1 ntdll!LdrpFindOrMapDll+0xf5 (FPO: [Non-Fpo])
        00d7fe1c 77a6232c ntdll!LdrpLoadDll+0x2b2 (FPO: [Non-Fpo])
        00d7fe50 75cc88ee ntdll!LdrLoadDll+0x92 (FPO: [Non-Fpo])
        00d7fe88 769f3c12 KERNELBASE!LoadLibraryExW+0x15a (FPO: [Non-Fpo])
        00d7fe9c 00de01bc kernel32!LoadLibraryW+0x11 (FPO: [Non-Fpo])
WARNING: Stack unwind information not available. Following frames may be wrong.
        00d7ff80 769f3c45 LoaderLockExe+0x401bc
        00d7ff8c 77a637f5 kernel32!BaseThreadInitThunk+0xe (FPO: [Non-Fpo])
        00d7ffcc 77a637c8 ntdll!__RtlUserThreadStart+0x70 (FPO: [Non-Fpo])
        00d7ffe4 00000000 ntdll!_RtlUserThreadStart+0x1b (FPO: [Non-Fpo])
</code></pre>
<h3 id="查看当前处于锁定状态的Critical-Section信息"><a href="#查看当前处于锁定状态的Critical-Section信息" class="headerlink" title="查看当前处于锁定状态的Critical Section信息"></a>查看当前处于锁定状态的Critical Section信息</h3><p>可以看到，有两个Critical Section处于锁定状态，其中LdrpLoaderLock(0x77ad7340)它被0x00000ec0这个线程占用，0x75615bb8被0x00000ffc这个线程占用。</p>
<pre><code class="bash">kd&gt; !cs <span class="_">-l</span>
-----------------------------------------
DebugInfo          = 0x77ad7540
Critical section   = 0x77ad7340 (ntdll!LdrpLoaderLock+0x0)
LOCKED
LockCount          = 0x1
WaiterWoken        = No
OwningThread       = 0x00000ec0
RecursionCount     = 0x1
LockSemaphore      = 0x104
SpinCount          = 0x00000000
-----------------------------------------
DebugInfo          = 0x005267a8
Critical section   = 0x75615bb8 (MozartBreathCore!HD<span class="built_in">bg</span>View::sta_ins+0xB0)
LOCKED
LockCount          = 0x0
WaiterWoken        = No
OwningThread       = 0x00000ffc
RecursionCount     = 0x1
LockSemaphore      = 0x0
SpinCount          = 0x00000000
</code></pre>
<h3 id="查看线程的简略信息"><a href="#查看线程的简略信息" class="headerlink" title="查看线程的简略信息"></a>查看线程的简略信息</h3><p>注意线程的Cid信息，如Cid 0104.0ffc标识，其中0ffc就是上面对应的线程id。<br>从而我们知道，88178b58这个线程，占用了0x75615bb8。</p>
<pre><code class="bash">kd&gt; !process 87ddb060 2
PROCESS 87ddb060  SessionId: 1  Cid: 0104    Peb: 7ffdf000  ParentCid: 05e4
    DirBase: 3f33b760  ObjectTable: 95ed5e78  HandleCount:  65.
    Image: LoaderLockExe.exe

        THREAD 87d42030  Cid 0104.0ffc  Teb: 7ffde000 W<span class="keyword">in</span>32Thread: fe8e6b50 WAIT: (UserRequest) UserMode Non-Alertable
            87<span class="built_in">fc</span>7e58  SynchronizationEvent

        THREAD 880c7a60  Cid 0104.08a4  Teb: 7ffdd000 W<span class="keyword">in</span>32Thread: 00000000 WAIT: (Executive) UserMode Non-Alertable
            87e7a704  Semaphore Limit 0x7fffffff

        THREAD 88178b58  Cid 0104.0ec0  Teb: 7ffdc000 W<span class="keyword">in</span>32Thread: 00000000 WAIT: (UserRequest) UserMode Non-Alertable
            880ee7d8  Mutant - owning thread 87d42030
</code></pre>
<h3 id="查看异常线程栈信息"><a href="#查看异常线程栈信息" class="headerlink" title="查看异常线程栈信息"></a>查看异常线程栈信息</h3><p>可以看到WaitForSingleObject这个API的第一个参数是000000fc，第二个参数是ffffffff.<br>函数原型是DWORD WINAPI WaitForSingleObject(HANDLE hHandle,DWORD dwMilliseconds);<br>所以我们查看一下000000fc这个句柄的信息。</p>
<pre><code class="bash">kd&gt; !thread 88178b58
THREAD 88178b58  Cid 0104.0ec0  Teb: 7ffdc000 W<span class="keyword">in</span>32Thread: 00000000 WAIT: (UserRequest) UserMode Non-Alertable
    880ee7d8  Mutant - owning thread 87d42030
Not impersonating
DeviceMap                 8a1fa350
Owning Process            87ddb060       Image:         LoaderLockExe.exe
Attached Process          N/A            Image:         N/A
Wait Start TickCount      11777          Ticks: 5312 (0:00:01:22.867)
Context Switch Count      3             
UserTime                  00:00:00.000
KernelTime                00:00:00.000
W<span class="keyword">in</span>32 Start Address LoaderLockExe (0x00ddde00)
Stack Init 9600bed0 Current 9600bac8 Base 9600c000 Limit 96009000 Call 0
Priority 8 BasePriority 8 UnusualBoost 0 ForegroundBoost 0 IoPriority 2 PagePriority 5
ChildEBP RetAddr  Args to Child              
9600bae0 83eb569d 88178b58 83f65f08 83f62d20 nt!KiSwapContext+0x26 (FPO: [Uses EBP] [0,0,4])
9600bb18 83eb44f7 88178c18 88178b58 880ee7d8 nt!KiSwapThread+0x266
9600bb40 83eae0cf 88178b58 88178c18 00000000 nt!KiCommitThreadWait+0x1df
9600bbb8 84060bad 880ee7d8 00000006 00000001 nt!KeWaitForSingleObject+0x393
9600bc20 83e751ea 000000<span class="built_in">fc</span> 00000000 00000000 nt!NtWaitForSingleObject+0xc6
9600bc20 77a470b4 000000<span class="built_in">fc</span> 00000000 00000000 nt!KiFastCallEntry+0x12a (FPO: [0,3] TrapFrame @ 9600bc34)
00d7f1d0 77a46a24 75cc179c 000000<span class="built_in">fc</span> 00000000 ntdll!KiFastSystemCallRet (FPO: [0,0,0])
00d7f1d4 75cc179c 000000<span class="built_in">fc</span> 00000000 00000000 ntdll!NtWaitForSingleObject+0xc (FPO: [3,0,0])
00d7f240 769ebaf3 000000<span class="built_in">fc</span> ffffffff 00000000 KERNELBASE!WaitForSingleObjectEx+0x98 (FPO: [Non-Fpo])
00d7f258 769ebaa2 000000<span class="built_in">fc</span> ffffffff 00000000 kernel32!WaitForSingleObjectExImplementation+0x75 (FPO: [Non-Fpo])
00d7f26c 754f7223 000000<span class="built_in">fc</span> ffffffff 75615bd4 kernel32!WaitForSingleObject+0x12 (FPO: [Non-Fpo])
00d7f284 754c424a b83b6b25 008c01bc 008c0000 MozartBreathCore!HMutexEx::lock+0x33 (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\ipc_tools\hmutexex.cpp @ 259]
00d7f634 7550a5a4 00d7f6b8 00d7f6b8 00d7f64c MozartBreathCore!HD<span class="built_in">bg</span>View::write+0xda (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hdbgview.cpp @ 293]
00d7f644 754dcc2b 00d7f65c 754dcc0d 00d7f6b8 MozartBreathCore!HString::debugview+0x24 (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hstring.cpp @ 3556]
00d7f64c 754dcc0d 00d7f6b8 75615c00 00d7f6e8 MozartBreathCore!HFileLog::debugview+0xb (CONV: cdecl) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hfilelog.cpp @ 305]
00d7f65c 75461e21 00d7f6b8 b83b6bf9 00d7f6b8 MozartBreathCore!HFileLog::system_debug_<span class="built_in">log</span>+0x1d (CONV: thiscall) [e:\works\uniaccess_unimon\blowsnow\<span class="built_in">source</span>\hfilelog.cpp @ 295]
00d7f6e8 754a9069 008c13e0 00000000 00000000 MozartBreathCore!MBCGlobal::is_loader_lock_locked+0xd1 (CONV: thiscall) [e:\works\uniaccess_unimon\uniaccess3_1\模块设计与源代码\uniaccessagent\mozartbreath\mozartbreathcore\mbcglobal.cpp @ 3389]
00d7f6<span class="built_in">fc</span> 7544c33e b83b64a1 00000000 00200000 MozartBreathCore!MBCReEntryMgr::is_re_entry+0x49 (CONV: thiscall) [e:\works\uniaccess_unimon\uniaccess3_1\模块设计与源代码\uniaccessagent\mozartbreath\mozartbreathcore\mbcreentrymgr.cpp @ 125]
00d7f9b0 75431794 00d7fb64 00d7<span class="built_in">fc</span>90 00100021 MozartBreathCore!MBCFile::action_create_file+0x15e (CONV: thiscall) [e:\works\uniaccess_unimon\uniaccess3_1\模块设计与源代码\uniaccessagent\mozartbreath\mozartbreathcore\mbcfiletool.cpp @ 2475]
00d7<span class="built_in">fc</span>04 77a6058b 00d7<span class="built_in">fc</span>90 00100021 00d7<span class="built_in">fc</span>30 MozartBreathCore!hook_ZwOpenFile+0xb4 (CONV: stdcall) [e:\works\uniaccess_unimon\uniaccess3_1\模块设计与源代码\uniaccessagent\mozartbreath\mozartbreathcore\mbcfile.cpp @ 491]
00d7<span class="built_in">fc</span>9c 77a5fbc1 00d7fce8 00d7fe48 00000000 ntdll!LdrpFindOrMapDll+0xf5 (FPO: [Non-Fpo])
00d7fe1c 77a6232c 00d7fe7c 00d7fe48 00000000 ntdll!LdrpLoadDll+0x2b2 (FPO: [Non-Fpo])
00d7fe50 75cc88ee 0051e10c 00d7fe90 00d7fe7c ntdll!LdrLoadDll+0x92 (FPO: [Non-Fpo])
00d7fe88 769f3c12 00000000 00000000 00000001 KERNELBASE!LoadLibraryExW+0x15a (FPO: [Non-Fpo])
00d7fe9c 00de01bc 00e5a074 00000000 00000000 kernel32!LoadLibraryW+0x11 (FPO: [Non-Fpo])
WARNING: Stack unwind information not available. Following frames may be wrong.
00d7ff80 769f3c45 00000000 00d7ffcc 77a637f5 LoaderLockExe+0x401bc
00d7ff8c 77a637f5 00000000 777b5a6a 00000000 kernel32!BaseThreadInitThunk+0xe (FPO: [Non-Fpo])
00d7ffcc 77a637c8 00ddde00 00000000 00000000 ntdll!__RtlUserThreadStart+0x70 (FPO: [Non-Fpo])
00d7ffe4 00000000 00ddde00 00000000 00000000 ntdll!_RtlUserThreadStart+0x1b (FPO: [Non-Fpo])
</code></pre>
<h3 id="查看异常的句柄信息"><a href="#查看异常的句柄信息" class="headerlink" title="查看异常的句柄信息"></a>查看异常的句柄信息</h3><pre><code class="bash">kd&gt; !handle <span class="built_in">fc</span> f

PROCESS 87ddb060  SessionId: 1  Cid: 0104    Peb: 7ffdf000  ParentCid: 05e4
    DirBase: 3f33b760  ObjectTable: 95ed5e78  HandleCount:  65.
    Image: LoaderLockExe.exe

Handle table at 99362000 with 65 entries <span class="keyword">in</span> use

00<span class="built_in">fc</span>: Object: 880ee7d8  GrantedAccess: 001f0001 Entry: 993621f8
Object: 880ee7d8  Type: (863d6898) Mutant
    ObjectHeader: 880ee7c0 (new version)
        HandleCount: 28  PointerCount: 80
        Directory Object: 99639450  Name: HD<span class="built_in">bg</span>ViewShareMem20101119Mutex_V3
</code></pre>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>可以看到，线程88178b58在占有了”HDbgViewShareMem20101119Mutex_V3”这个Mutex后，去请求LdrpLoaderLock。而线程87d42030在获取了LdrpLoaderLock，又去请求”HDbgViewShareMem20101119Mutex_V3”。两个线程相互等待，进程死锁。很明显，是这个输出日志的锁设定得有点问题，修改代码Fix掉这个Bug。</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Windbg/" rel="tag">#Windbg</a>
          
            <a href="/tags/内核调试/" rel="tag">#内核调试</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2016/06/全世界最漂亮的女孩子.html" rel="next" title="全世界最漂亮的女孩子">
                <i class="fa fa-chevron-left"></i> 全世界最漂亮的女孩子
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="/blog/2016/06/debug-system-huang.html"
           data-title="记录一次系统卡死的调试" data-url="http://www.xn--vz0au16b.com/blog/2016/06/debug-system-huang.html">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Sven" />
          <p class="site-author-name" itemprop="name">Sven</p>
          <p class="site-description motion-element" itemprop="description">天下有大勇者，卒然临之而不惊。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">2</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用Vmware搭建双机调试环境"><span class="nav-number">1.</span> <span class="nav-text">使用Vmware搭建双机调试环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调试详解"><span class="nav-number">2.</span> <span class="nav-text">调试详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#加载nt模块的符号表"><span class="nav-number">2.1.</span> <span class="nav-text">加载nt模块的符号表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示正在运行的进程"><span class="nav-number">2.2.</span> <span class="nav-text">显示正在运行的进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#附加到任意一个异常进程"><span class="nav-number">2.3.</span> <span class="nav-text">附加到任意一个异常进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看异常的线程信息"><span class="nav-number">2.4.</span> <span class="nav-text">查看异常的线程信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#切换调试上下文件到异常进程"><span class="nav-number">2.5.</span> <span class="nav-text">切换调试上下文件到异常进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载应用层符号表，显示异常进程的信息"><span class="nav-number">2.6.</span> <span class="nav-text">加载应用层符号表，显示异常进程的信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看当前处于锁定状态的Critical-Section信息"><span class="nav-number">2.7.</span> <span class="nav-text">查看当前处于锁定状态的Critical Section信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看线程的简略信息"><span class="nav-number">2.8.</span> <span class="nav-text">查看线程的简略信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看异常线程栈信息"><span class="nav-number">2.9.</span> <span class="nav-text">查看异常线程栈信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看异常的句柄信息"><span class="nav-number">2.10.</span> <span class="nav-text">查看异常的句柄信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sven</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"chencong"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
      
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  






  
  
  

  

  

</body>
</html>
